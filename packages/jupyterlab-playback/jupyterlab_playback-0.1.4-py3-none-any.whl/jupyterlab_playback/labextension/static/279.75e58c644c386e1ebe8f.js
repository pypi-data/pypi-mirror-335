"use strict";(self.webpackChunkjupyterlab_playback=self.webpackChunkjupyterlab_playback||[]).push([[279],{279:(e,t,o)=>{o.r(t),o.d(t,{default:()=>w});var n=o(158),a=o(752),i=o(120),d=o(256),l=o(979),s=o(916);async function r(e="",t={}){const o=s.ServerConnection.makeSettings(),n=l.URLExt.join(o.baseUrl,"jupyterlab-playback",e);let a;try{a=await s.ServerConnection.makeRequest(n,t,o)}catch(e){throw new s.ServerConnection.NetworkError(e)}let i=await a.text();if(i.length>0)try{i=JSON.parse(i)}catch(e){console.log("Not a JSON response body.",a)}if(!a.ok)throw new s.ServerConnection.ResponseError(a,i.message||i);return i}var c=o(813),u=o(24),m=o(195);const g=e=>e?e.map((e=>e.command.join("+"))).join("\n"):"",p=e=>{const t=e.split("\n"),o=t.length||0,n=[];for(let e=0;e<o;e++){const o=t[e];/^\s*#/.test(o)?n.push({command:["TYPE","AUDIO"]}):/^\s*$/.test(o)?n.push({command:["PAUSE500"]}):n.push({command:["TYPE"]})}return{map:n,doc:g(n)}},v=(e,t)=>new Promise((o=>{const n=()=>{const a=e.content.widgets[t].node.getElementsByClassName("lm-Widget lm-Panel jp-Cell-inputWrapper")[0];a?o(a):requestAnimationFrame(n)};n()})),h=e=>u.ViewPlugin.fromClass(class{constructor(t){this.decorations=this.createLineHighlight(t,e)}createLineHighlight(e,t){const o=new m.RangeSetBuilder,n=e.state.doc.line(t),a=u.Decoration.line({class:"highlight-line"});return o.add(n.from,n.from,a),o.finish()}update(t){t.docChanged&&(this.decorations=this.createLineHighlight(t.view,e))}},{decorations:e=>e.decorations}),y=async(e,t,o,n)=>{var a,i;const d=document.getElementById("extension-button");let l=o;if("audio_index"in e[o])for(;l>0&&"audio_index"in e[l-1]&&e[l-1].audio_index===e[l].audio_index;)l-=1;null===(a=null==n?void 0:n.model)||void 0===a||a.setMetadata("cellIndex",t),null===(i=null==n?void 0:n.model)||void 0===i||i.setMetadata("lineIndex",l),d&&(d.innerHTML=" ▶ "),await r("stop",{method:"POST",body:""})},f={id:"jupyterlab-playback:plugin",description:"A JupyterLab extension.",autoStart:!0,requires:[n.INotebookTracker,a.ISettingRegistry],activate:async(e,t,o)=>{console.log("JupyterLab extension jupyterlab-playback is activated!");const a=(await o.load(f.id)).get("metadataEditorWidth").composite;t.widgetAdded.connect((async(e,o)=>{var l,s,f;await o.revealed,await o.sessionContext.ready;const w=document.createElement("button");w.id="extension-button";const b=document.createElement("div");b.appendChild(w),o.toolbar.insertAfter("spacer","button",new d.Widget({node:b}));const M=null===(l=o.model)||void 0===l?void 0:l.getMetadata("mode");M||null===(s=o.model)||void 0===s||s.setMetadata("mode","editor"),M&&"editor"!==M?"player"===M&&(w.innerHTML=" ▶ ",null===(f=o.model)||void 0===f||f.setMetadata("isPlaying",!1),w.onclick=()=>{var e,t;const a=(null===(e=o.model)||void 0===e?void 0:e.getMetadata("isPlaying"))||!1;null===(t=o.model)||void 0===t||t.setMetadata("isPlaying",!a),a||(async e=>{var t,o,a,i,d,l,s;const c=null===(t=e.model)||void 0===t?void 0:t.cells,u=(null===(o=e.model)||void 0===o?void 0:o.getMetadata("cellIndex"))||0,g=(null===(a=e.model)||void 0===a?void 0:a.getMetadata("lineIndex"))||0,p=document.getElementById("extension-button");if(c){p?p.innerHTML="||":console.warn("null button");let t=null;for(let o=u;o<c.length;o++){let a="";const d=c.get(o);if("code"===d.type){const l=d.getMetadata("full_map");for(let s=0;s<(null==l?void 0:l.length);s++){const c=l[s].command,p=l[s].text;if(o===u&&s<g)a+=p,s!=(null==l?void 0:l.length)-1&&(a+="\n"),d.sharedModel.setSource(a);else{if(!e.model.getMetadata("isPlaying"))return void await y(l,o,s,e);if(c.some((e=>e.includes("AUDIO")))){const e=l[s].audio_src;e!==t&&(t=e,await r("audio",{method:"POST",body:JSON.stringify({audio_src:t})}))}for(const t of c){if(t.includes("TYPE")){const t=[...p];s!=(null==l?void 0:l.length)-1&&t.push("\n");for(let n of t)if(a+=n,d.sharedModel.setSource(a),await new Promise((e=>{setTimeout(e,50)})),!e.model.getMetadata("isPlaying"))return void await y(l,o,s,e)}if(t.includes("PAUSE")){const e=t.replace(/\D/g,"");a+="\n",d.sharedModel.setSource(a),await new Promise((t=>{setTimeout(t,e)}))}if(t.includes("SELECT")){const n=t.replace(/\D/g,""),a=null===(i=e.content.widgets[o])||void 0===i?void 0:i.editor,d=h(n);a.editor.dispatch({effects:m.StateEffect.appendConfig.of([d])})}t.includes("EXECUTE")&&n.NotebookActions.runCells(e.content,[e.content.widgets[o]],e.context.sessionContext)}}}}}}p&&(p.innerHTML=" ▶ "),null===(d=e.model)||void 0===d||d.setMetadata("cellIndex",""),null===(l=e.model)||void 0===l||l.setMetadata("lineIndex",""),null===(s=e.model)||void 0===s||s.setMetadata("isPlaying",!1)})(o)}):((async(e,t)=>{var o,n;const a=(null===(o=e.model)||void 0===o?void 0:o.cells.length)||0;for(let o=0;o<a;o++){const a=null===(n=e.model)||void 0===n?void 0:n.cells.get(o);if(a&&"code"==a.type){await e.content.widgets[o].ready;const n=await v(e,o),i=n.getElementsByClassName("jp-Cell-inputArea")[0];i.classList.add("code-editor"),i.style.width=(100-t).toString()+"%";const d=document.createElement("div");d.classList.add("metadata-editor"),d.style.width=t.toString()+"%";const l=a.getMetadata("map")?g(a.getMetadata("map")):(()=>{const{map:e,doc:t}=p(a.sharedModel.source);return a.setMetadata("map",e),t})(),s=m.EditorState.create({doc:l,extensions:[c.basicSetup,(0,u.lineNumbers)(),u.EditorView.updateListener.of((e=>{e.docChanged&&a.setMetadata("map",e.state.doc.toString().split("\n").map((e=>({command:e.split("+")}))))}))]});new u.EditorView({state:s,parent:d}),n.appendChild(d)}}})(o,a),w.innerHTML="Generate an interactive notebook",w.onclick=async()=>{var e,n;w.innerHTML="Generating notebook...";const a=await r("load",{method:"POST",body:JSON.stringify({data:null===(e=null==o?void 0:o.model)||void 0===e?void 0:e.toJSON(),relativePath:null===(n=t.currentWidget)||void 0===n?void 0:n.context.path})});(0,i.showDialog)({body:a,buttons:[i.Dialog.createButton({label:"Dismiss",className:"jp-Dialog-button jp-mod-reject jp-mod-styled"})]})},w.innerHTML="Regenerate interactive notebook")}))}},w=f}}]);
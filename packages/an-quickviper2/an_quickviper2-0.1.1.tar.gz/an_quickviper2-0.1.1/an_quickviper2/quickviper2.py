# -*- coding: utf-8 -*-
"""QVP2_20250322_00.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1MW7oabgjP5d3iWGl7_bb54iyMncIbXzu

# QuickViper2
Conda実行環境権限不足に対応するため、

1. conda-packで仮想環境の圧縮書庫を作成
2. 1.でできた圧縮書庫をtarで指定フォルダに解凍
3. conda-unpackで、コピーに伴うプレフィックスを不具合を修正

を行う。



```
2025/03/22 0.1.0 完成
2025/03/22 0.1.1 バグ修正
```

# QuickViper2

## 1. モジュール定義
"""

# @title a. GDrive接続とcondacolab設定
if __name__ == '__main__':
    get_ipython().system( "pip install an_CondaInitializer" )
    from an_condainitializer import CondaInitializer

    condainitializer = CondaInitializer()

# @title b. QuickViper2 定義
import os
import re
import json
import yaml
import shutil
import subprocess

from pathlib import Path


get_ipython().system( "pip install an_DebugHelper" )
from an_debughelper import DebugHelper
get_ipython().system( "pip install an_EnvManager" )
from an_envmanager import EnvManager


class QuickViper2:
    def __init__( self ):
        from google.colab import drive
        drive.mount( '/content/drive' )

        self.debug = DebugHelper( instance_name = "QuickViper2" )
        self.debug.enable_log_to_file_stdout()
        self.debug.enable_log_to_file_stderr()
        self.debug.enable_timestamp()

        # env_file_list に読み込む.envファイルを指定（デフォルトは settings_ven.env）
        self.envmanager = EnvManager(env_files=["settings_ven.env"])
        # 環境変数LD_LIBRARY_PATHのバックアップを取る。
        self.bkup_env = os.environ.get("LD_LIBRARY_PATH", "")

        # 環境変数から各種パスを読み出し
        self.base_folder = self.envmanager.get_env_var("Ven_base_folder")
        self.venv_folder = self.envmanager.get_env_var("Ven_venv_folder")
        self.app_folder = self.envmanager.get_env_var("Ven_app_folder")
        self.venv_config_folder = self.envmanager.get_env_var("Ven_venv_config_folder")
        self.venv_contents_folder = self.envmanager.get_env_var("Ven_venv_contents_folder")
        self.local_venv_folder = self.envmanager.get_env_var("Ven_local_venv_folder")
        self.local_app_folder = self.envmanager.get_env_var("Ven_local_app_folder")
        self.archive_folder = self.envmanager.get_env_var("Ven_archive_folder")
        self.chunked_folder = self.envmanager.get_env_var("Ven_chunked_folder")

        self.bch_path = os.path.join( self.venv_contents_folder )
        self.dst_path = os.path.join( self.local_venv_folder )

        self.debug.disable_debug()
        self.debug.log_step( f"LD_LIBRARY_PATH : { self.bkup_env }", success = None )
        self.debug.log_step( f"bch_path : { self.bch_path }", success = None )
        self.debug.log_step( f"dst_path : { self.dst_path }", success = None )
        self.debug.enable_debug()

    def set_env_value( self, venv_name, back = 0 ):
        self.venv_name = venv_name
        self.cur_path = Path( self.base_folder )
        self.src_path = Path( self.venv_folder ).joinpath( self.venv_name, self.venv_contents_folder )
        self.arc_path = Path( self.archive_folder ).joinpath( "arcvenv" ).with_suffix( ".tar.gz" )
        self.chk_path = os.path.join( self.chunked_folder )
        self.lcl_path = Path( self.local_venv_folder ).joinpath( self.venv_name, self.venv_contents_folder )
        self.bin_path = self.lcl_path.joinpath( "bin" )
        self.lib_path = self.lcl_path.joinpath( "lib" )
        self.debug.disable_debug()
        self.debug.log_step( f"venv_name : { self.venv_name }", success = None, back = back )
        self.debug.log_step( f"cur_path  : { self.cur_path }", success = None, back = back )
        self.debug.log_step( f"src_path  : { self.src_path }", success = None, back = back )
        self.debug.log_step( f"arc_path  : { self.arc_path }", success = None, back = back )
        self.debug.log_step( f"chk_path  : { self.chk_path }", success = None, back = back )
        self.debug.log_step( f"lcl_path  : { self.lcl_path }", success = None, back = back )
        self.debug.log_step( f"bin_path  : { self.bin_path }", success = None, back = back )
        self.debug.log_step( f"lib_path  : { self.lib_path }", success = None, back = back )
        self.debug.enable_debug()

    def compress_venv( self, venv_name ):
        self.debug.log_step( "compress_venv", success = None )
        self.set_env_value( venv_name, back = 1 )

        # get_ipython().system( "conda install -c conda-forge conda-pack" )
        # conda-pack --prefix . --format tar --output /path/to/myenv.tar
        cd_cmd = f"cd { Path( self.src_path ).joinpath( self.venv_name ) }"
        ex_cmd = f"conda-pack --prefix { self.src_path } --format tar.gz --output { self.arc_path }"
        self.debug.log_step( f"cd_cmd : { cd_cmd }" )
        self.debug.log_step( f"ex_cmd : { ex_cmd }" )
        get_ipython().system( cd_cmd )
        get_ipython().system( ex_cmd )

    def list_archive( self, venv_name ):
        self.debug.log_step( "list_archive", success = None )
        self.set_env_value( venv_name, back = 1 )
        get_ipython().system( f"tar tvf { self.arc_path }" )
        # 実行コマンドをリスト形式で定義
        #cmd = [str(self.bin_path / "python"), "-m", "pip", "--version"]
        cmd = [ "tar", "tvf", str(self.arc_path ) ]
        # コマンドを実行して出力をキャプチャ
        result = subprocess.run(cmd, capture_output=True, text=True)
        self.debug.log_step( f"stdout:\n{ result.stdout }", success = None)
        self.debug.log_step( f"stderr:\n{ result.stdout }", success = None)

    def delete_venv( self, venv_name ):
        self.debug.log_step( "delete_venv", success = None )
        self.set_env_value( venv_name, back = 1 )
        shutil.rmtree( self.lcl_path )

    def extract_venv( self, venv_name ):
        self.debug.log_step( "extract_venv", success = None )
        self.set_env_value( venv_name, back = 1 )
        os.chdir( self.cur_path )
        os.makedirs( self.lcl_path, exist_ok = True )
        cmd = f"tar -xf { self.arc_path } -C {self.lcl_path}"
        get_ipython().system( cmd )

    def conda_unpack( self, venv_name ):
        self.debug.log_step( "conda_unpack", success = None )
        self.set_env_value( venv_name, back = 1 )
        os.chdir( self.lcl_path )
        get_ipython().system( f"./bin/conda-unpack" )

    def set_executable( self, venv_name ):
        self.debug.log_step( "set_executable", success = None )
        self.set_env_value( venv_name, back = 1 )
        get_ipython().system( f"chmod 755 { self.bin_path / 'python3.10' }" )
        get_ipython().system( f"chmod 755 { self.bin_path / 'python' }" )
        get_ipython().system( f"ls -l { self.bin_path / 'python3.10' }" )
        get_ipython().system( f"ls -l { self.bin_path / 'python' }" )

    def set_ld_library_path( self, venv_name ):
        self.debug.log_step( "set_ld_library_path", success = None )
        """
        指定した new_path を既存のLD_LIBRARY_PATHの先頭に追加します。
        """
        self.set_env_value( venv_name, back = 1 )
        current = os.environ.get("LD_LIBRARY_PATH", "")
        if current:
            # os.environ["LD_LIBRARY_PATH"] = f"{self.lib_path}:{current}"
            os.environ["LD_LIBRARY_PATH"] = f"{self.lib_path}:{ self.bkup_env }"
        else:
            os.environ["LD_LIBRARY_PATH"] = self.lib_path
        self.debug.log_step(f"Updated LD_LIBRARY_PATH: {os.environ['LD_LIBRARY_PATH']}", success = None )

    def unlock( self, venv_name, force_unlock = False ):
        self.debug.log_step( "unlock", success = None )
        self.set_env_value( venv_name, back = 1 )
        if force_unlock and Path( self.lcl_path ).exists():
            shutil.rmtree( self.lcl_path )
        if not Path( self.lcl_path ).exists():
            quick_viper2.extract_venv( venv_name = venv_name )
            quick_viper2.conda_unpack( venv_name = venv_name )
            quick_viper2.set_executable( venv_name = venv_name )
            quick_viper2.set_ld_library_path( venv_name = venv_name )

    def executer( self, venv_name, cmdlist = [ "pip", "--version" ] ):
        self.debug.log_step( "exe_python", success = None )
        self.set_env_value( venv_name, back = 1 )
        os.chdir( self.bin_path )
        # get_ipython().system( "env | grep LD_LIBRARY_PATH" )

        # 現在の環境変数をコピー
        env = os.environ.copy()
        # シェルを使って "env | grep LD_LIBRARY_PATH" を実行し、出力をキャプチャ
        # result = subprocess.run(["env"], env=env, capture_output=True, text=True)
        result = subprocess.run("env | grep ^LD_LIBRARY_PATH=", shell=True, env=env, capture_output=True, text=True)
        self.debug.log_step( f"result : { result }", success = None )

        # cmd = f"{ self.bin_path / 'python' } -m pip --version"
        # self.debug.log_step( f"cmd : { cmd }", success = None )
        # get_ipython().system( cmd )

        # 実行コマンドをリスト形式で定義
        cmd = [str(self.bin_path / "python"), "-m"]
        full_cmd = cmd + cmdlist
        # コマンドを実行して出力をキャプチャ
        self.debug.log_step( f"full_cmd : { full_cmd }", success = None )
        result = subprocess.run(full_cmd, env=env, capture_output=True, text=True)
        self.debug.log_step( f"stdout:\n{ result.stdout }", success = None)
        self.debug.log_step( f"stderr:\n{ result.stdout }", success = None)



if __name__ == "__main__":
    quick_viper2 = QuickViper2()
    # quick_viper2.compress_venv( venv_name = "kohya_env" )
    # quick_viper2.list_archive( venv_name = "kohya_env" )
    quick_viper2.unlock( venv_name = "kohya_env" )
    quick_viper2.executer( venv_name = "kohya_env" )
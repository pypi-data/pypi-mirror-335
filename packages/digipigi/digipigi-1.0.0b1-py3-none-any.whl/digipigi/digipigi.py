import socket
import numpy as np

atts={}
atts['c10kOhm']=[0.004641566503819177, 0.008331175391187969, 0.01237991846582149, 0.015622824137512464, 0.019565297451280644, 0.023581322975582845, 0.02710624545690113, 0.030239316588649423, 0.03370511160073877, 0.03784546501700204, 0.04117946057831399, 0.04468616388990399, 0.0481672853920045, 0.0516127366531755, 0.05482654709587633, 0.05846788607265834, 0.06216296217604207, 0.06567488061896104, 0.06931496752583684, 0.0725241902054797, 0.07607069719456364, 0.07928167635859891, 0.08257162592677642, 0.08616445279785108, 0.08947222853164415, 0.09240396402144553, 0.09599191999876057, 0.09923095479166393, 0.10243419838292914, 0.10550949123687457, 0.1087108599377154, 0.11191001374252321, 0.11521251875223477, 0.11803827695149394, 0.12132426875618471, 0.1243512108880788, 0.12752763902985487, 0.1305821254325807, 0.13391409483248465, 0.13664465658162347, 0.1403301414795057, 0.1437124968389617, 0.1468201450093362, 0.1497765407748778, 0.1526843507057146, 0.15584097687878154, 0.15885181295600528, 0.16184795969190668, 0.16477854281843357, 0.1679656777740996, 0.1710096371582963, 0.17371986132423609, 0.1770136972545875, 0.17990627308227772, 0.1826407273877238, 0.18565278130038787, 0.1887285071491309, 0.19169511766694675, 0.1944807251155028, 0.19748065072321194, 0.2005139554864167, 0.20328395405346078, 0.2063467001240456, 0.20946330201501626, 0.21187821102903392, 0.2153299305745839, 0.2181234875052404, 0.2209787995804162, 0.2240829912281402, 0.22692061639911726, 0.22981648944200947, 0.23322855190342906, 0.2363063210573275, 0.23895178944302684, 0.239481401654006, 0.24495604127640216, 0.24747280315043055, 0.2504170032101243, 0.2532245400745513, 0.25587107409938736, 0.2588130412662267, 0.2618834150351538, 0.2643640602384947, 0.2673047535272424, 0.2701682949924011, 0.2730204592513945, 0.2758153052821494, 0.27880532251365453, 0.2821675956481344, 0.2848396949987395, 0.2878871730592421, 0.2909290874114308, 0.2938287776033803, 0.29715125669259373, 0.2995265179486635, 0.30248877419253695, 0.30546439047067914, 0.3088726035465238, 0.3115849162431375, 0.3144080598087516, 0.31700832666096407, 0.3195817496554501, 0.3226862165272093, 0.32588846013140405, 0.32922081974492856, 0.331982475268013, 0.3352225683933751, 0.33799910254716503, 0.3409907604963618, 0.3440763766745529, 0.34699938106616157, 0.34993534370970253, 0.35273888643214246, 0.3556684648106157, 0.35866010697011896, 0.36170787846289354, 0.3647914816309887, 0.36799526521431997, 0.3707706242687376, 0.37377438184265255, 0.377046397231328, 0.3804339440459905, 0.3832211859774354, 0.3862246594597053, 0.38953232404005894, 0.392351922812487, 0.39535039711551334, 0.3982441657518851, 0.4015434080417828, 0.4047415577225489, 0.4079541951004005, 0.4108383119546911, 0.4139450398021286, 0.41725783146899176, 0.42029189599964706, 0.4233870516004792, 0.4260226494350804, 0.4295199086066857, 0.4327612180490513, 0.4356952613916913, 0.4389795675596643, 0.44226133869156575, 0.4455069259789285, 0.44873646785466675, 0.4520385328540723, 0.45528433681692954, 0.4586737223631868, 0.46176886948956486, 0.46506984808159707, 0.46824198633622544, 0.47148490715581176, 0.47522658824316466, 0.47837153656878123, 0.4820432936243032, 0.4851460147034252, 0.48874367032267474, 0.4921545655447092, 0.49531207558184526, 0.4985283851189193, 0.5021583804032875, 0.506041990625323, 0.5096781759035071, 0.5134092529500132, 0.5171039550526437, 0.5207285840430796, 0.5243155320685638, 0.5280467884964378, 0.531479774931263, 0.5350871420466794, 0.5385210832476232, 0.5424177542866154, 0.545871725053383, 0.5495063188729243, 0.553337291573931, 0.5570230682934716, 0.5609408232175975, 0.5650806097908063, 0.5688880169678256, 0.5729553438867653, 0.5764416017178957, 0.5807927769255788, 0.5844237561505449, 0.5887120391812357, 0.5919699427996233, 0.5962889062923129, 0.6005711868892256, 0.6043510105621497, 0.6082842882885304, 0.6122856636652882, 0.6165082021424414, 0.6206273770904079, 0.6244602398797099, 0.6286044162347902, 0.6334076826376803, 0.6377325862577103, 0.6420124237260255, 0.646195485403017, 0.6505154334953304, 0.6550546409196363, 0.6592127757692426, 0.6639109871426092, 0.6685834512114669, 0.6733739580384028, 0.6775293347086336, 0.682421052313026, 0.6866658897073755, 0.6913341227232668, 0.695787351636362, 0.7004324326916155, 0.7052054199639496, 0.7101159414844797, 0.7148063734643121, 0.719765599568211, 0.7246780069467152, 0.7293360749419648, 0.7346456465018418, 0.7397412076573382, 0.7446876063817304, 0.7492924640339249, 0.7548986254124177, 0.7602262584055095, 0.7653304917636081, 0.7706257707273436, 0.7754603790388714, 0.7811672510974088, 0.7862386475434427, 0.7921278821636927, 0.7968810665537172, 0.8026322269103292, 0.8078384176245732, 0.8138544225016888, 0.8194176536092405, 0.8251162283056805, 0.8310035764149053, 0.8364136544309952, 0.8422067751272445, 0.847985864909857, 0.8541775376304498, 0.8609442418166205, 0.8665945214116857, 0.8725948848412066, 0.8788386883718334, 0.8849732771062504, 0.8911539383599082, 0.8976593857489844, 0.9038686712999932, 0.9103580300662177, 0.916865976172602, 0.9239165275632839, 0.930679734388076, 0.9372741685623247, 0.9444420574525034, 0.9513441910181251, 0.9581185895300318, 0.9646316232689945, 0.972007740696881]
atts['c10MOhm']=[0.004941170426945494, 0.008628954349542533, 0.012386709322862273, 0.016193501903350515, 0.020183383424634934, 0.02412818784458293, 0.02784402809678925, 0.031458695879287575, 0.0353645091320711, 0.039444425478030024, 0.04320436884937981, 0.0469003497992029, 0.05087767378592671, 0.054602403461100374, 0.05862757711354235, 0.062439224904281734, 0.06617887397660843, 0.06996607846138791, 0.07414111017518028, 0.07776785568190461, 0.08196197266775151, 0.08552168006833416, 0.08941068899488168, 0.09307372856433352, 0.09728668998282888, 0.10133387779765857, 0.10470715701003044, 0.10843172843246113, 0.11225969962646946, 0.116245514123003, 0.11989711939668954, 0.12351260610193786, 0.1276616395616782, 0.13077019586087088, 0.13529415579994045, 0.13894392111130868, 0.14261941501988, 0.1470728628825628, 0.15052016735380266, 0.154613363620746, 0.15874676387705436, 0.16242361503530922, 0.16599900673720733, 0.1699389422022876, 0.17412315603744394, 0.17775015044029222, 0.1812214112762377, 0.18505143294494755, 0.1891176655809688, 0.19332613293226417, 0.19665048514560843, 0.2004613891070767, 0.20460815130403223, 0.20840565506066136, 0.21217580908141132, 0.2160323474141418, 0.22031035706921273, 0.22394473774136855, 0.22795712240715194, 0.23198850413959932, 0.2358863218294569, 0.23961928149715062, 0.2432947285317437, 0.24715208979720005, 0.2512004612431278, 0.2548765322129643, 0.25888971395084637, 0.26236872662338945, 0.265919621366449, 0.27012363983355264, 0.27366330994545773, 0.2776349113900706, 0.28157696692205203, 0.28549624598441364, 0.2889718732907893, 0.2928368304658178, 0.2969113119409787, 0.3006324435740041, 0.30455657310762496, 0.30790052161728454, 0.3120385640041911, 0.3161421887203656, 0.31983289708999946, 0.32400076274956463, 0.32714922052382367, 0.3310639811842869, 0.33505081062536846, 0.33880826605880515, 0.3425135136395828, 0.3474455905123065, 0.35062830056833255, 0.3549392047119261, 0.3588478452724711, 0.362353689616968, 0.365614558186665, 0.36985972757841973, 0.37507092726293445, 0.3780394643504906, 0.3807999596406185, 0.38537561549351385, 0.39036007788375404, 0.3933844734584729, 0.3958763170776325, 0.40032780731401496, 0.4052838356744786, 0.4085419053386034, 0.4126576180244162, 0.4173521532141296, 0.4206195960740845, 0.4237359731519512, 0.4290802583910659, 0.43185385940725557, 0.4353797510710431, 0.44045072049708917, 0.44363498638946264, 0.4459056641750204, 0.4511641894605138, 0.4549410575493066, 0.45764949889196416, 0.4618229666804835, 0.46630559888761897, 0.4692845818506588, 0.47399028248420083, 0.4778541867661413, 0.4815880742282154, 0.4853665986223594, 0.4892962217465302, 0.49323826587026043, 0.4974018622506688, 0.5024002835928485, 0.5051958856346984, 0.5096782136255158, 0.5130445750177263, 0.5161546151379297, 0.5205776306622116, 0.5245714907823783, 0.5281921549244573, 0.5321549090916629, 0.5360817461357965, 0.5395201450005999, 0.5431820335992869, 0.5479328289764583, 0.5512428075900433, 0.5548415370610382, 0.5586123603995437, 0.5623442184642856, 0.5653682694276645, 0.5701148734205125, 0.574306611983454, 0.5780517816470575, 0.5819024384504313, 0.585379148698609, 0.5895017400645745, 0.5934979541530875, 0.5974922185677803, 0.6009689452889722, 0.6043957030467296, 0.6085369092721701, 0.6122008140900679, 0.6161574253174579, 0.6202051708610806, 0.6240142074829363, 0.6273744427533118, 0.6331920399069646, 0.6352776710463044, 0.6392188019583492, 0.64330995948699, 0.6475809854372773, 0.6513089997682582, 0.6550658100477305, 0.6589147793588819, 0.6611382832018246, 0.6664346664322485, 0.6713399338309198, 0.6731680694421954, 0.6778062486195414, 0.6836930090971064, 0.6862528194771348, 0.689464226510706, 0.696022265471675, 0.6973096425310711, 0.7001646948149611, 0.7053505073150076, 0.7089723506921347, 0.7132352115320681, 0.7168381954667824, 0.7206682323297937, 0.72616622068914, 0.7281397046665832, 0.7318894291338384, 0.7359859619792956, 0.7406031308119003, 0.7432977307712015, 0.7471496009370342, 0.7521543265184348, 0.7532342843898953, 0.7589561379731783, 0.7628864173131451, 0.7641954500255574, 0.7704101217177611, 0.7739789507020719, 0.7782681205150126, 0.782000951476453, 0.7874646993461967, 0.7880476580840353, 0.7930783044799232, 0.7978934864582984, 0.8006529833695403, 0.8051832043720565, 0.8090918832541601, 0.8132574083409242, 0.8172839130231859, 0.8211087554811113, 0.8249095771141943, 0.827823966356104, 0.8323953876182817, 0.8362877815871749, 0.8400906558306404, 0.8440894330636577, 0.8476434236407496, 0.8521295993260121, 0.8558375415331393, 0.8594940126114746, 0.863054126404651, 0.8673891557897426, 0.8710585588242811, 0.874678353083464, 0.8791002473258464, 0.8823370648610158, 0.8862237383854769, 0.8904994518688516, 0.8945076336869447, 0.8976663695226195, 0.9017482877649894, 0.9051255638549934, 0.909319448863621, 0.9135005051952365, 0.9173589206012674, 0.9208915035647791, 0.9249185778588664, 0.9291707196295015, 0.9328504971502184, 0.9366406685006178, 0.9403469929681431, 0.9446095393001597, 0.9483428223842683, 0.9518729394440472, 0.9556477571037113, 0.9600957957311181, 0.9632808496834856, 0.9679196732123508, 0.9709940575880434, 0.9750206108922052, 0.9789039705726729, 0.98254126757184, 0.9865198871642131]


class DigiPigi():

    def __init__(self,HOST='digipigi1-cmtqo',PORT=60606, verbose=False, load : str = 'c10kOhm'):
        """ Class to operate the network attached digitial potentiometer digipigi

        Parameters
        ==========
        HOST: str
            hostname of the network attached device
        PORT: int
            port at which the socket server is listening for commands
        vebose: bool
            well, how talkative
        load: str
            which load is the digipigi driving, currently calibrated are c10kOhm an c10MOhm
            
        """
        assert load in ['c10kOhm', 'c10MOhm'], f"Provde load either 'c10kOhm' or 'c10MOhm'"
        self.HOST=HOST
        self.PORT=PORT
        self.verbose = verbose
        self.attenuation=atts[load]


    def setAttenuation(self,value : int = 255) -> float:
        """ Set the attenuation factor
        
        Parameters
        ==========
        value: int
            integer value between 1 (maximal attenuation) and 255 (minimal attenuation)

        Returns
        =======

        float with the calibrated attenuation factor
        """
        assert isinstance(value, int), f"Expected parameter to be int, got {type(value).__name__}"
        assert value >=0 and value < 256, f"Expected parameter between 0 and 256 got {value}"
        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as client:
            client.settimeout(5)  # Set a 5-second timeout
            try:
                client.connect((self.HOST, self.PORT))
                client.sendall(b"%d\n" % value)
                response = client.recv(1024)
                if self.verbose:
                    print(f"Response: {response}")
            except socket.timeout:
                print("Connection timed out!")
            except Exception as e:
                print(f"An error occurred: {e}")

            client.sendall(b"%d\n"%value) 
            response = client.recv(1024)
            if self.verbose:
                print("Response:", response.decode())
            return self.attenuation[value]
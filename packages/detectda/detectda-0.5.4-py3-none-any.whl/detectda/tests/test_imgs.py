from ..imgs import ImageSeriesPickle, ImageSeries
import numpy as np
from shapely import Polygon
from skimage import filters

pe = np.array([5.83177356, 5.78757364, 5.75705866, 5.76387676, 5.57014188,
       5.56476744, 5.55905737, 5.53827007, 5.55254119, 5.60307477,
       5.79345152, 5.81101324, 5.76317307, 5.68501903, 5.68366028,
       5.63072437, 5.67006345, 5.62698355, 5.5539655 , 5.60410169,
       5.49462915, 5.53690678, 5.42345542, 5.48758809, 5.49896691,
       5.57489101, 5.56867752, 5.46138898, 5.52939182, 5.56819236,
       5.49142747, 5.49204526, 5.56080203, 5.61159033, 5.53321159,
       5.41926682, 5.4370886 , 5.51983767, 5.51225515, 5.53939667,
       5.55526027, 5.45921117, 5.47153165, 5.45631348, 5.53325363,
       5.68689601, 5.72131227, 5.65318907, 5.69398173, 5.58415843,
       5.56555805, 5.65486919, 5.60691551, 5.59249834, 5.59101407,
       5.68688708, 5.7022624 , 5.62188384, 5.47674452, 5.54341038,
       5.51609486, 5.53065456, 5.57784485, 5.67265792, 5.60563722,
       5.56746574, 5.48443805, 5.47301092, 5.4883068 , 5.53721843,
       5.43932671, 5.4336925 , 5.41281142, 5.39564522, 5.53153569,
       5.63887551, 5.67293891, 5.75581665, 5.78281384, 5.65627962,
       5.66105326, 5.63452541, 5.57467975, 5.61938116, 5.58070507,
       5.75965329, 5.69070348, 5.66650322, 5.69134712, 5.685661  ,
       5.66783873, 5.68866716, 5.70745098, 5.6344029 , 5.64776146,
       5.59791702, 5.59346149, 5.67337429, 5.60851777, 5.67004874,
       5.69165783, 5.67405733, 5.72173738, 5.74914891, 5.67092209,
       5.70826895, 5.67424839, 5.63531018, 5.73746999, 5.72147367,
       5.68771784, 5.65933341, 5.63195776, 5.69589716, 5.73182697,
       5.76886596, 5.69401359, 5.73050441, 5.7431635 , 5.85745706])

alps = np.array([1.9615879 , 2.6640929 , 2.64014499, 2.62315035, 2.75734034,
       2.81250663, 2.82578625, 2.85241663, 2.79906459, 2.84636146,
       2.66077717, 2.59143555, 2.55349972, 2.57356188, 2.61950729,
       2.80961994, 2.60338072, 2.7362401 , 2.68705941, 2.64278778,
       3.01305086, 2.78178569, 3.08340919, 2.97163649, 3.02277626,
       2.99230877, 2.96211655, 3.07707148, 2.84324966, 2.73861357,
       2.81022907, 2.97824317, 2.93337817, 2.94381759, 2.79303192,
       3.0781322 , 2.89404032, 2.88526851, 2.89462517, 2.82196124,
       2.94158103, 2.97675045, 2.96920976, 2.99638771, 2.88567946,
       2.71051455, 2.80967177, 2.91053509, 2.696253  , 2.72508507,
       2.77324859, 2.71040343, 2.71806397, 2.77674987, 2.87416598,
       2.84921126, 2.7559594 , 2.83830719, 2.87135613, 2.85545002,
       2.8926499 , 2.93326313, 2.86172778, 2.69186303, 2.83171184,
       2.90272157, 2.86284959, 2.93853225, 2.95437799, 2.87249174,
       2.8519319 , 2.86339222, 2.91062883, 3.18431846, 2.86288948,
       2.75181964, 2.76921344, 2.64693305, 2.5969269 , 2.74353262,
       2.88108979, 2.83389136, 2.80972915, 2.77643999, 2.8180894 ,
       2.66803327, 2.74314075, 2.74827889, 2.71088732, 2.59641297,
       2.78953285, 2.8416235 , 2.6584849 , 2.74946183, 2.81375207,
       2.85218889, 2.76889451, 2.82661201, 2.87893332, 2.75254055,
       2.81170451, 2.7971844 , 2.72210312, 2.67834183, 2.54769648,
       2.78061273, 2.69624469, 2.8229155 , 2.61236573, 2.72266058,
       2.81825799, 2.71084416, 2.78533116, 2.74390122, 2.5215319 ,
       2.51680415, 2.74526832, 2.7820793 , 2.7689674 , 2.41534495])

def test_ps():
    impol = ImageSeriesPickle('test_video.pkl', div=32, n_jobs=2)
    impol.fit(sigma=2)
    impol.get_pers_entr(neg=False)
    impol.get_alps()
    np.testing.assert_almost_equal(impol.alps, alps, 7)
    np.testing.assert_almost_equal(impol.pers_entr, pe, 7)

test_poly2 = Polygon([[1, 20], [10, 20], [10, 30], [1, 30]])
test_im2 = np.full((51, 51), 1)
test_im2[25,5] = 0 
test_im2[25,6] = 0
test_im2[25,45] = 0.5
test_im2 = np.round(filters.gaussian(test_im2,1, preserve_range=True),1)
test_im2[25,6] = 0.8

def test_poly():
    test_dtda2 = ImageSeries(test_im2, test_poly2)
    test_dtda2.fit(sigma=0)
    test_dtda2.plot_im(0)

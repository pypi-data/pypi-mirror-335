"use strict";(self.webpackChunk_datalayer_ui=self.webpackChunk_datalayer_ui||[]).push([[5741],{85741:(e,t,n)=>{n.d(t,{a:()=>X});var o=n(47011),s=n(83504),i=n(51834),r=n(46830),a=n(71801),l=n(16982),c=n(70994),d=n(16909),h=n(46744),_=n(57528),m=n(22248),u=n(82628),p=n(79443),f=n(94910),b=n(98403),g=n(17389),y=n(92664),k=n(26766),x=n(65211),C=n(29907),v=n(39265),w=n(44066),P=n(3202),S=n(30102),M=n(2585),j=n(79418),N=n(21259),E=n(68311),T=n(81392),K=n(40393),I=n(82724),D=n(46086),F=n(91412),R=n(37371),L=n(4632),W=n(59913),J=n(30148),U=n(54362),z=n(22187),A=n(92850),B=n(80469),O=n(90793),$=n(77268);class H extends $.w{_nbformat;_readonly;constructor(e){super(e),this._nbformat=e.nbformat,this._readonly=e.readonly}createNew(e){if(this._nbformat){this._nbformat.cells.forEach((e=>{e.metadata.editable=!this._readonly}));const e=new a.V;return e.fromJSON(this._nbformat),e}{const t=super.createNew(e);return t.readOnly=this._readonly,t}}}var Z=n(45205);class V{_boxPanel;_commands;_contentFactory;_context;_documentRegistry;_iPyWidgetsManager;_id;_kernel;_kernelConnection;_kernelClients;_kernelTransfer;_lite;_mimeTypeService;_nbformat;_notebookModelFactory;_notebookPanel;_onSessionConnection;_path;_readonly;_renderers;_rendermime;_serverless;_serviceManager;_tracker;_url;constructor(e){console.log("Creating a new Notebook Adapter."),this._id=e.id,this._kernel=e.kernel,this._kernelClients=e.kernelClients,this._lite=e.lite,this._nbformat=e.nbformat,this._path=e.path,this._readonly=e.readonly,this._renderers=e.renderers,this._serverless=e.serverless,this._serviceManager=e.serviceManager,this._url=e.url,this._kernelTransfer=e.kernelTransfer,this._onSessionConnection=e.onSessionConnection,this._boxPanel=new U.jN,this._boxPanel.addClass("dla-Jupyter-Notebook"),this._boxPanel.spacing=0,this._commands=new J.H,e.url?this.loadFromUrl(e.url).then((e=>{this._nbformat=e,this.setupAdapter()})):this.setupAdapter()}async loadFromUrl(e){return fetch(e).then((e=>e.text())).then((e=>JSON.parse(e)))}notebookKeydownListener=e=>{this._commands?.processKeydownEvent(e)};setupCompleter(e){const t=e.content.activeCell&&e.content.activeCell.editor,n=e.context.sessionContext,o=new v.B,s=new w.X({editor:t,model:o}),i=new P.D,r=new S.K({context:{widget:e,editor:t,session:n.session},providers:[i],timeout:1e3}),a=new M._({completer:s,reconciliator:r});return n.ready.then((()=>{const e=new P.D,o=new S.K({context:{widget:this._notebookPanel,editor:t,session:n.session},providers:[e],timeout:1e3});a.reconciliator=o})),a.editor=t,e.content.activeCellChanged.connect(((e,t)=>{t&&t.ready.then((()=>{a.editor=t&&t.editor}))})),s.hide(),U.$L.attach(s,document.body),a}initializeContext(){const e=void 0===this._path||""===this._path;this._context=new j._({manager:this._serviceManager,factory:this._notebookModelFactory,path:this._path??".datalayer/ping.ipynb",kernelPreference:{id:this._kernel?.id,shouldStart:!1,canStart:!1,autoStartDefault:!1,shutdownOnDispose:!1}}),this._iPyWidgetsManager=new z.fH(this._context,this._rendermime,{saveState:!1});const t={safe:!0,mimeTypes:[x.w],defaultRank:1,createRenderer:e=>new A.d(e,this._iPyWidgetsManager)};if(this._rendermime.addFactory(t,1),this._kernelClients?.map((e=>{this._iPyWidgetsManager?.registerWithKernel(e)})),this._context.sessionContext._initialize=async()=>{const e=this._context.sessionContext.sessionManager;await e.ready,await e.refreshRunning();const t=(0,W.sE)(e.running(),(e=>e.kernel?.id===this._kernel?.id));if(t)try{const n=e.connectTo({model:{...t,path:this._path??t.path,name:this._path??t.name},kernelConnectionOptions:{handleComms:!0}});this._context.sessionContext._handleNewSession(n),this._kernel?.connection?.dispose()}catch(e){return this._context.sessionContext._handleSessionError(e),Promise.reject(e)}return await this._context.sessionContext._startIfNecessary()},e&&(this._context._populate=async()=>{if(this._context._isPopulated=!0,this._context._isReady=!0,this._context._populatedPromise.resolve(void 0),this._context.isDisposed)return;const e=this._context._model.defaultKernelName||this._context.sessionContext.kernelPreference.name;this._context.sessionContext.kernelPreference={...this._context.sessionContext.kernelPreference,name:e,language:this._context._model.defaultKernelLanguage},this._context.sessionContext.initialize().then((e=>{e&&this._context._dialogs.selectKernel(this._context.sessionContext.sessionContext)}))},this._context.initialize=async e=>{this._context.model.dirty=!1;const t=(new Date).toISOString(),n={path:this._id,name:this._id,type:"notebook",content:void 0,writable:!0,created:t,last_modified:t,mimetype:"application/x-ipynb+json",format:"json"};this._context._updateContentsModel(n),await this._context._populate(),this._context.model.sharedModel.clearUndoHistory()}),this._context.sessionContext.sessionChanged.connect(((e,t)=>{const n=t.newValue;console.log("Current Jupyter Session Connection.",n),this._onSessionConnection&&n&&(this._onSessionConnection(n),this._iPyWidgetsManager?.registerWithKernel(n.kernel),this._iPyWidgetsManager?.restoreWidgets(this._notebookPanel?.model))})),this._context.sessionContext.kernelChanged.connect(((e,t)=>{const n=t.newValue;this._kernelConnection=n,console.log("Current Jupyter Kernel Connection.",n),n&&!n.handleComms&&(console.log("Updating the current Kernel Connection to enforce Comms support.",n.handleComms),n.handleComms=!0)})),this._context.sessionContext.ready.then((()=>{this._onSessionConnection&&this._onSessionConnection(this._context?.sessionContext.session??void 0);const e=this._context?.sessionContext.session?.kernel;this._kernelConnection=e,this._kernelTransfer&&e&&e.connectionStatusChanged.connect(((t,n)=>{"connected"===n&&this._kernelTransfer.transfer(e)}))})),!this._notebookPanel){const e=this._documentRegistry?.getWidgetFactory("Notebook");this._notebookPanel=e?.createNew(this._context)}const n=this.setupCompleter(this._notebookPanel);if(!this._readonly)try{(0,Z.$6)(this._commands,n,this._tracker,this._path)}catch{}this._boxPanel.addWidget(this._notebookPanel),U.jN.setStretch(this._notebookPanel,0),window.addEventListener("resize",(()=>{this._notebookPanel?.update()})),this._context.initialize(e).then((()=>{e&&this._notebookPanel?.model?.fromJSON(this._nbformat)}))}setupAdapter(){document.addEventListener("keydown",this.notebookKeydownListener,!0);const e=R.Nf.filter((e=>"text/javascript"!==e.mimeTypes[0]));e.push(T.rendererFactory),e.push(E.rendererFactory),this._renderers.map((t=>e.push(t)));const t=new C.BE;for(const e of C.BE.getDefaultLanguages())t.addLanguage(e);t.addLanguage({name:"ipythongfm",mime:"text/x-ipythongfm",load:async()=>(await Promise.all([n.e(534),n.e(1891),n.e(8159),n.e(5863)]).then(n.bind(n,75863))).markdown({codeLanguages:e=>t.findBest(e)})}),this._rendermime=new L.D({initialFactories:e,latexTypesetter:new K.U,markdownParser:(0,O.G)(t)}),this._documentRegistry=new N.z({}),this._mimeTypeService=new C.E1(t);const o=new C.Ie;for(const e of C.Ie.getDefaultThemes())o.addTheme(e);const s=new C.rM({extensions:(()=>{const e=new C.C9;for(const t of C.C9.getDefaultExtensions({themes:o}))e.addExtension(t);return e.addExtension({name:"shared-model-binding",factory:e=>{const t=e.model.sharedModel;return C.C9.createImmutableExtension((0,C.Zw)({ytext:t.ysource,undoManager:t.undoManager??void 0}))}}),e})(),languages:t}),i={factoryService:s,mimeTypeService:this._mimeTypeService},r=i.factoryService.newInlineEditor;this._contentFactory=new B.ex({editorFactory:r}),this._tracker=new I.a({namespace:this._id});const a=new D.y({name:"Notebook",label:"Notebook",modelName:"notebook",fileTypes:["notebook"],defaultFor:["notebook"],preferKernel:!0,autoStartDefault:!1,canStartKernel:!1,shutdownOnClose:!1,rendermime:this._rendermime,contentFactory:this._contentFactory,mimeTypeService:i.mimeTypeService,notebookConfig:{...F.l.defaultNotebookConfig,recordTiming:!0}});a.widgetCreated.connect(((e,t)=>{t.context.pathChanged.connect((()=>{this._tracker?.save(t)})),this._tracker?.add(t)})),this._documentRegistry.addWidgetFactory(a),this._notebookModelFactory=new H({nbformat:this._nbformat,readonly:this._readonly}),this._documentRegistry.addModelFactory(this._notebookModelFactory),this.initializeContext()}get id(){return this._id}get readonly(){return this._readonly}get serverless(){return this._serverless}get lite(){return this._lite}get path(){return this._path}get url(){return this._url}get nbformat(){return this._nbformat}get kernel(){return this._kernel}get kernelConnection(){return this._kernelConnection}get notebookPanel(){return this._notebookPanel}get context(){return this._context}set notebookPanel(e){this._notebookPanel=e}get panel(){return this._boxPanel}get commands(){return this._commands}get serviceManager(){return this._serviceManager}setNbformat(e){if(!e)throw new Error("The nbformat should first be set via the constructor of NotebookAdapter");this._nbformat!==e&&(this._nbformat=e,this._notebookPanel?.model?.fromJSON(e))}setServiceManager(e,t){this._lite=t,this._serviceManager=e,this._nbformat=this._notebookPanel?.model?.toJSON()}setKernel(e){this._kernel!==e&&(this._kernel=e,this.initializeContext())}setReadonly(e){this._readonly!==e&&(this._readonly=e,this._notebookPanel?.content.widgets.forEach((t=>{t.syncEditable=!0,t.model.sharedModel.setMetadata("editable",!e)})),Array.from(this._context?.model.cells).forEach((t=>{t.setMetadata("editable",!e)})),this._notebookPanel?.content.widgets.forEach((e=>{e.saveEditableState()})))}setServerless(e){this._serverless!==e&&(this._serverless=e)}setPath(e){this._path!==e&&(this._path=e,this.initializeContext())}assignKernel(e){this._kernel=e,this._context?.sessionContext.changeKernel({id:e.id})}setDefaultCellType=e=>{this._notebookPanel.content.notebookConfig.defaultCell=e};changeCellType=e=>{const t=this._notebookPanel.content,n=t.model.sharedModel;t.widgets.forEach(((o,s)=>{if(t.isSelectedOrActive(o)){if(o.model.type!==e){const t=o.model.toJSON();n.transact((()=>{n.deleteCell(s);const o=n.insertCell(s,{cell_type:e,source:t.source,metadata:t.metadata});t.attachments&&["markdown","raw"].includes(e)&&(o.attachments=t.attachments)}))}"markdown"===e&&((o=t.widgets[s]).rendered=!1)}})),t.deselectAll()};insertAbove=e=>{const t=this._notebookPanel.content,n=this._notebookPanel.context.model,o=t.activeCell?t.activeCellIndex:0;n.sharedModel.insertCell(o,{cell_type:t.notebookConfig.defaultCell,source:e,metadata:"code"===t.notebookConfig.defaultCell?{trusted:!0}:{}}),t.activeCellIndex=o,t.deselectAll()};insertBelow=e=>{const t=this._notebookPanel.content,n=this._notebookPanel.context.model,o=t.activeCell?t.activeCellIndex+1:0;n.sharedModel.insertCell(o,{cell_type:t.notebookConfig.defaultCell,source:e,metadata:"code"===t.notebookConfig.defaultCell?{trusted:!0}:{}}),t.activeCellIndex=o,t.deselectAll()};dispose=()=>{document.removeEventListener("keydown",this.notebookKeydownListener,!0),this._context?.dispose(),this._notebookPanel?.dispose(),this._boxPanel.dispose()}}var Y=n(46523),q=n(15889);const G=r.vJ`
  .dla-Box-Notebook .jp-Cell .dla-CellSidebar-Container {
    display: none;
  }
  .dla-Box-Notebook .jp-Cell.jp-mod-active .dla-CellSidebar-Container {
    display: block;
  }
`,X=e=>{const{serviceManager:t,defaultKernel:n,lite:r}=(0,b.W$)({lite:e.lite,serverless:e.serverless,serviceManager:e.serviceManager,startDefaultKernel:e.startDefaultKernel,useRunningKernelId:e.useRunningKernelId,useRunningKernelIndex:e.useRunningKernelIndex}),{Toolbar:x,collaborative:C,extensions:v,height:w,maxHeight:P,nbformat:S,path:M,readonly:j,serverless:N,url:E}=e,[T,K]=(0,d.useState)(e.id||(0,u.ZI)()),[I,D]=(0,d.useState)(),[F,R]=(0,d.useState)(new Array),L=e.kernel??n,W=(0,Y.qL)(),J=W.selectNotebookPortals(T),[U,z]=(0,d.useState)(!1),A=async(t,n)=>{const s=new V({...e,id:T,lite:r,kernel:n,serviceManager:t});D(s),v.forEach((e=>{e.init({notebookId:T,commands:s.commands,panel:s.notebookPanel}),e.createNew(s.notebookPanel,s.context),R(F.concat(e.component??(0,o.jsx)(o.Fragment,{})))})),W.update({id:T,state:{adapter:s}}),s.notebookPanel?.content.modelChanged.connect(((e,t)=>{e.model&&W.changeModel({id:T,notebookModel:e.model})})),s.notebookPanel?.content.activeCellChanged.connect(((e,t)=>{null===t?W.activeCellChange({id:T,cellModel:void 0}):W.activeCellChange({id:T,cellModel:t})})),s.notebookPanel?.sessionContext.statusChanged.connect(((e,t)=>{W.changeKernelStatus({id:T,kernelStatus:t})})),s.serviceManager.ready.then((()=>{if(!j){const t=s.notebookPanel.content.activeCell;t&&W.activeCellChange({id:T,cellModel:t}),(e=s.notebookPanel.content.activeCellChanged,new p.y((t=>{function n(e,n){t.next(n)}return e.connect(n),()=>{e.disconnect(n)}}))).subscribe((e=>{W.activeCellChange({id:T,cellModel:e});const t=document.getElementById("right-panel-id");if(t){const n=(0,o.jsx)(c.Z,{mt:3,children:(0,o.jsx)(k.o,{cellModel:e.model})}),s=(0,h.createPortal)(n,t);W.setPortalDisplay({id:T,portalDisplay:{portal:s,pinned:!1}})}}))}var e}))},B=(e,t)=>{t?t.ready.then((()=>{A(e,t)})):A(e,t)},O=()=>{I?.notebookPanel?.disposed.connect(((e,t)=>{I&&(W.dispose(T),D(void 0))})),I?.notebookPanel?.dispose()};return(0,d.useEffect)((()=>{(t&&N||t&&L)&&B(t,L)}),[t,L]),(0,d.useEffect)((()=>{let e=null,n=new l.PromiseDelegate,o=!0,r=null;const c=t=>{t.code>1e3&&(console.error("Connection with the room has been closed unexpectedly.",t),e?.disconnect(),4002===t.code&&(e?.destroy(),n.reject("Connection closed."),n=new l.PromiseDelegate,o&&(z(!0),Promise.all([h(),n.promise,(0,u._v)(500)]).catch((e=>{console.error("Failed to setup collaboration connection.",e)})).finally((()=>{o&&z(!1)})))))},d=t=>{t&&(e?.off("sync",d),n.resolve(void 0))},h=async()=>{if(I?.notebookPanel&&o){r=new s.hN;const{ydoc:n,awareness:o}=r;if("jupyter"==C){const s=m.D7.getState().jupyterConfig?.jupyterServerToken,r=await(0,g.jf)("json","notebook",M),a=i.URLExt.join(t?.serverSettings.wsUrl,g.W8),l=`${r.format}:${r.type}:${r.fileId}`;e=new _.VU(a,l,n,{disableBc:!0,params:{sessionId:r.sessionId,token:s},awareness:o})}else if("datalayer"==C){const{runUrl:t,token:s}=m.D7.getState().datalayerConfig??{},r=T,a=i.URLExt.join(t,"/api/spacer/v1/rooms"),l=await(0,y.J)({url:i.URLExt.join(a,r),token:s});e=new _.VU(a.replace(/^http/,"ws"),r,n,{disableBc:!0,params:{sessionId:l,token:s},awareness:o})}if(e){e.on("sync",d),e.on("connection-close",c),console.log("Collaboration is setup with websocket provider.");const t=new a.V({collaborationEnabled:!0,disableDocumentWideUndoRedo:!0,sharedModel:r}),n=I.notebookPanel.content.model;I.notebookPanel.content.model=t,n?.dispose()}}};return C&&(z(!0),Promise.all([h(),n.promise,(0,u._v)(500)]).catch((e=>{console.error("Failed to setup collaboration connection.",e)})).finally((()=>{o&&z(!1)}))),()=>{o=!1,e&&(e.synced?Promise.resolve():n.promise).finally((()=>{e?.off("sync",d),e?.off("connection-close",c),e?.disconnect(),e?.destroy()})),r?.dispose()}}),[I?.notebookPanel,C]),(0,d.useEffect)((()=>{I&&I.kernel!==L&&I.setKernel(L)}),[L]),(0,d.useEffect)((()=>{I&&I.readonly!==j&&I.setReadonly(j)}),[j]),(0,d.useEffect)((()=>{I&&I.serverless!==N&&I.setServerless(N)}),[N]),(0,d.useEffect)((()=>{I&&I.nbformat!==S&&I.setNbformat(S)}),[S]),(0,d.useEffect)((()=>{I&&M&&I.path!==M&&(O(),B(t))}),[M]),(0,d.useEffect)((()=>{I&&E&&I.url!==E&&(O(),B(t))}),[E]),(0,d.useEffect)((()=>()=>{O()}),[]),(0,o.jsxs)(c.Z,{style:{height:w,width:"100%",position:"relative"},id:"dla-Jupyter-Notebook",children:[x&&(0,o.jsx)(x,{notebookId:T}),(0,o.jsxs)(c.Z,{className:"dla-Box-Notebook",sx:{"& .dla-Jupyter-Notebook":{height:w,maxHeight:P,width:"100%",overflowY:"hidden"},"& .datalayer-NotebookPanel-header":{minHeight:"50px"},"& .jp-Notebook":{flex:"1 1 auto !important",height:"100%",overflowY:"scroll"},"& .jp-NotebookPanel":{height:"100% !important",width:"100% !important"},"& .jp-Toolbar":{display:"none",zIndex:0},"& .jp-Toolbar .jp-HTMLSelect.jp-DefaultStyle select":{fontSize:"14px"},"& .jp-Toolbar > .jp-Toolbar-responsive-opener":{display:"none"},"& .jp-Toolbar-kernelName":{display:"none"},"& .jp-Cell":{width:`calc(100% - ${e.cellSidebarMargin}px)`},"& .jp-Notebook-footer":{width:`calc(100% - ${e.cellSidebarMargin+82}px)`},"& .jp-CodeMirrorEditor":{cursor:"text !important"},".dla-Box-Notebook":{position:"relative"}},children:[(0,o.jsx)(o.Fragment,{children:J?.map((e=>e))}),(0,o.jsx)(G,{}),(0,o.jsx)(c.Z,{children:F.map(((e,t)=>(0,o.jsx)(c.Z,{children:e},`${e}-${t}`)))}),U?(0,o.jsx)(q.a,{}):(0,o.jsx)(c.Z,{children:I&&(0,o.jsx)(f.Y,{id:T,children:I.panel})})]})]})};X.defaultProps={cellMetadataPanel:!1,cellSidebarMargin:120,collaborative:void 0,extensions:[],height:"100vh",kernelClients:[],maxHeight:"100vh",nbgrader:!1,readonly:!1,renderId:0,renderers:[],serverless:!1,startDefaultKernel:!1}}}]);
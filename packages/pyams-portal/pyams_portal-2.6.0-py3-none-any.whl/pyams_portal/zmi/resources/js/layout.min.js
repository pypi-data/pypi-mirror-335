"use strict";void 0===window.$&&(window.$=MyAMS.$);const getLocation=()=>{return $("#portal_config").data("ams-location")},portal={i18n:{CANT_DELETE_ROW_WITH_PORTLETS:"A row containing portlets can't be removed!",CANT_DELETE_SLOT_WITH_PORTLETS:"A slot containing portlets can't be removed!",SWITCH_SLOT_VISIBILITY:"Show/hide slot"},template:{initConfig:()=>{const t=$("#portal_config");t.data("ams-allowed-change")&&($(".rows",t).addClass("sortable"),$(".slots",t).addClass("sortable"),$(".slot",t).addClass("resizable"),$(".portlets",t).addClass("sortable"),MyAMS.registry.plugins.plugins.get("dragdrop").run(t).then(()=>{$(".btn-row",".btn-toolbar").draggable({cursor:"move",helper:"clone",revert:"invalid",connectToSortable:".rows"}),$(".rows",t).droppable({accept:".btn-row",drop:MyAMS.portal.template.dropRowButton}),$(".btn-slot",".btn-toolbar").draggable({cursor:"move",helper:"clone",revert:"invalid",connectToSortable:".slots"}),$(".slots",t).droppable({accept:".btn-slot",drop:MyAMS.portal.template.dropSlotButton}),$(".btn-portlet",".btn-toolbar").draggable({cursor:"move",helper:"clone",revert:"invalid",connectToSortable:".portlets"}),$(".portlets",t).droppable({accept:".btn-portlet",hoverClass:"portlets-hover",activeClass:"portlets-active",drop:MyAMS.portal.template.dropPortletButton})}))},selectDisplay:t=>{const e=$(t.target).val();MyAMS.ajax.post(`${getLocation()}/get-slots-width.json`,{device:e}).then(t=>{const a=$("#portal_config");a.removeClassPrefix("container-"),e&&a.addClass(`container-${e}`),$(".slot",a).removeClassPrefix("col-");for(const o in t){if(!t.hasOwnProperty(o))continue;const s=t[o],r=$(`.slot[data-ams-slot-name="${o}"]`,a);if(e)r.addClass(`col-${s[e]}`);else for(const t in s)s.hasOwnProperty(t)&&r.addClass(`col-${t}-${s[t]}`);r.addClass(s.css)}})},addRow:t=>{const e=t.currentTarget;$(e).parents(".dropdown").dropdown("hide"),MyAMS.ajax.post(`${getLocation()}/add-template-row.json`,{}).then(t=>{const e=t.row_id,a=$(".rows","#portal_config");$("<div></div>").addClass("row context-menu").attr("data-ams-row-id",e).append($("<strong></strong>").addClass("row_id badge badge-danger pull-left").text(e+1)).append($("<strong></strong>").addClass("row_id badge badge-danger pull-right").text(e+1)).append($("<div></div>").addClass("slots").sortable({placeholder:"slot-highlight",connectWith:".slots",over:MyAMS.portal.template.overSlots,stop:MyAMS.portal.template.sortSlots}).droppable({accept:".btn-slot",drop:MyAMS.portal.template.dropSlotButton})).contextMenu({menuSelector:"#rowMenu",menuSelected:MyAMS.helpers.contextMenuHandler}).appendTo(a),a.sortable("refresh")})},dropRowButton:(t,e)=>{e.draggable.hasClass("already-dropped")||(console.debug(e.draggable),e.draggable.tooltip("hide"),e.draggable.addClass("already-dropped"),MyAMS.ajax.post(`${getLocation()}/add-template-row.json`,{}).then(t=>{const a=t.row_id,o=$(".rows","#portal_config");e.draggable.removeClassPrefix("btn").removeClassPrefix("ui-").removeClassPrefix("bg-").removeClass("hint").removeClass("already-dropped").removeAttr("data-original-title").removeAttr("style").addClass("row context-menu").attr("data-ams-row-id",a).empty().append($("<strong></strong>").addClass("row_id badge badge-danger pull-left").text(a+1)).append($("<strong></strong>").addClass("row_id badge badge-danger pull-right").text(a+1)).append($("<div></div>").addClass("slots").addClass("width-100").sortable({placeholder:"slot-highlight",connectWith:".slots",over:MyAMS.portal.template.overSlots,stop:MyAMS.portal.template.sortSlots}).droppable({accept:".btn-slot",drop:MyAMS.portal.template.dropSlotButton})).contextMenu({menuSelector:"#rowMenu",menuSelected:MyAMS.helpers.contextMenuHandler}),MyAMS.portal.template.sortRows(),o.sortable("refresh")}))},overRows:(t,e)=>{$(e.placeholder).attr("class",$(e.item).attr("class")).removeClassPrefix("ui-").addClass("row-highlight").css("height",$(e.item).outerHeight()).css("width","100%")},sortRows:(t,e)=>{if(e&&e.item.hasClass("already-dropped"))return;const a=$("#portal_config"),o=$(".row",a).listattr("data-ams-row-id");MyAMS.ajax.post(`${getLocation()}/set-template-row-order.json`,{rows:JSON.stringify(o)}).then(t=>{"success"===t.status&&$(".row",a).each((t,e)=>{$(e).attr("data-ams-row-id",t),$(".row_id",$(e)).text(t+1)})})},deleteRow:()=>(function(t){const e=t.parents(".dropdown-menu").data("contextmenu-event-source"),a=$(".portlet",e);MyAMS.require("alert").then(()=>{a.exists()?MyAMS.alert.messageBox({status:"error",title:MyAMS.i18n.ERROR_OCCURED,content:MyAMS.portal.i18n.CANT_DELETE_ROW_WITH_PORTLETS}):MyAMS.alert.bigBox({status:"danger",title:MyAMS.i18n.WARNING,message:MyAMS.i18n.DELETE_WARNING,icon:"fas fa-bell"}).then(t=>{"success"===t&&MyAMS.require("ajax").then(()=>{MyAMS.ajax.post(`${getLocation()}/delete-template-row.json`,{row_id:e.data("ams-row-id")}).then(t=>{"success"===t.status&&(e.remove(),$(".row","#portal_config").each((t,e)=>{$(e).removeData().attr("data-ams-row-id",t),$(".row_id",e).text(t+1)}))})})})})}),addSlot:t=>{const e=t.currentTarget;$(e).parents(".dropdown").dropdown("hide"),MyAMS.require("modal").then(()=>{MyAMS.modal.open(`${getLocation()}/add-template-slot.html`)})},addSlotCallback:(t,e)=>{const a=$(".slots",`.row[data-ams-row-id="${e.row_id}"]`),o=e.slot_name,s=$("#device_selector").val(),r=$("<div></div>").addClass(`slot px-0 col col-12 col-${s}-12 resizable`).attr("data-ams-slot-name",o).append($("<div></div>").addClass("header px-1 d-flex align-items-center").append('<i class="action mr-1 fa fa-fw fa-minus-square pull-right padding-top-2"    data-ams-click-handler="MyAMS.portal.template.switchSlot"></i>').append($('<span class="flex-grow-1"></span>').append(o).append('<i class="action ml-2 fa fa-fw fa-eye"    data-ams-click-handler="MyAMS.portal.template.switchSlotVisibility"></i>')).append('<i class="action fa fa-fw fa-edit float-right"   data-ams-click-handler="MyAMS.portal.template.editSlot"></i>').append('<i class="action fa fa-fw fa-trash float-right"   data-ams-click-handler="MyAMS.portal.template.deleteSlot"></i>')).append($("<div></div>").addClass("portlets").sortable({placeholder:"portlet-highlight",connectWith:".portlets",over:MyAMS.portal.template.overPortlets,stop:MyAMS.portal.template.sortPortlets}).droppable({accept:".btn-portlet",hoverClass:"portlets-hover",activeClass:"portlets-active",drop:MyAMS.portal.template.dropPortletButton})).append($("<div></div>").addClass("clearfix")),l=$(".btn-slot",a);l.exists()?(l.replaceWith(r),$(".slot",a).each((t,e)=>{$(e).removeData()}),MyAMS.portal.template.sortSlots()):r.appendTo(a),$(".slot",a).resizable({start:MyAMS.portal.template.startSlotResize,resize:MyAMS.portal.template.resizeSlot,stop:MyAMS.portal.template.stopSlotResize,handles:"e"}),a.sortable("refresh")},dropSlotButton:(t,e)=>{e.draggable.hasClass("already-dropped")||(e.draggable.addClass("already-dropped"),MyAMS.require("modal").then(()=>{const t=e.helper.parents(".row:first").data("ams-row-id");MyAMS.modal.open(`${getLocation()}/add-template-slot.html?form.widgets.row_id=${t}`).then(t=>{$(".hint").tooltip("hide"),t.on("hide.bs.modal",e=>{$("form",t).data("submitted")||$(".already-dropped").remove()})})}))},startSlotResize:(t,e)=>{const a=e.element,o=a.parents(".slots:first"),s=o.innerWidth()/12,r=a.height();e.element.resizable("option","grid",[s,r]),e.element.resizable("option","minWidth",10),e.element.resizable("option","minHeight",r),e.element.resizable("option","maxWidth",o.innerWidth()),e.element.resizable("option","maxHeight",r)},resizeSlot:(t,e)=>{const a=e.element,o=a.parents(".slots:first").innerWidth()/12,s=Math.round(e.size.width/o),r=$("#device_selector").val();a.removeClassPrefix("col-").removeAttr("style").addClass(`col-${r}-${s}`)},stopSlotResize:(t,e)=>{const a=e.element,o=a.parents(".slots:first").innerWidth()/12,s=Math.round($(a).width()/o),r=$("#device_selector").val();MyAMS.require("ajax").then(()=>{MyAMS.ajax.post(`${getLocation()}/set-slot-width.json`,{slot_name:a.data("ams-slot-name"),device:r,width:s}).then(t=>{a.removeClassPrefix("col-"),a.removeAttr("style");const e=t[a.data("ams-slot-name")];a.addClass(`col-${r}-${e[r]}`).addClass(e.css)})})},editSlot:t=>{let e=$(t.target);e.hasClass("slot")||(e=e.parents(".slot")),MyAMS.require("modal").then(()=>{MyAMS.modal.open(`${getLocation()}/slot-properties.html?form.widgets.slot_name=${e.data("ams-slot-name")}`)})},editSlotCallback:(t,e)=>{const a=$(`.slot[data-ams-slot-name="${e.slot_name}"]`);a.attr("class","slot px-0 col");const o=$("#device_selector").val();if(o)a.addClass(`col-${e.width[o]}`);else for(const t in e.width)e.width.hasOwnProperty(t)&&a.addClass(`col-${t}-${e.width[t]}`);a.addClass(e.css)},overSlots:(t,e)=>{$(e.placeholder).attr("class",$(e.item).attr("class")).removeClassPrefix("ui-").addClass("slot-highlight").css("height",$(e.item).outerHeight())},sortSlots:(t,e)=>{if(e&&e.item.hasClass("already-dropped"))return;const a=$("#portal_config"),o={};$(".row",a).each((t,e)=>{const a=$(e),s=[];$(".slot",a).each((t,e)=>{s.push($(e).data("ams-slot-name"))}),o[parseInt(a.attr("data-ams-row-id"))]=s}),MyAMS.require("ajax").then(()=>{MyAMS.ajax.post(`${getLocation()}/set-template-slot-order.json`,{order:JSON.stringify(o)})})},switchSlot:t=>{const e=$(t.currentTarget),a=e.parents(".header").first().siblings(".portlets");a.hasClass("hidden")?(a.removeClass("hidden"),MyAMS.core.switchIcon(e,"plus-square","minus-square")):(a.addClass("hidden"),MyAMS.core.switchIcon(e,"minus-square","plus-square"))},switchSlotVisibility:t=>{let e=$(t.currentTarget).objectOrParentWithClass("action");const a=e.objectOrParentWithClass("slot");e.tooltip("hide"),e.replaceWith('<i class="action ml-2 fas fa-fw fa-spinner fa-spin"></i>'),MyAMS.require("ajax").then(()=>{MyAMS.ajax.post(`${getLocation()}/switch-slot-visibility.json`,{slot_name:a.data("ams-slot-name")}).then(t=>{e=$(".fa-spin",a).objectOrParentWithClass("action"),t.status?($(".portlets",a).removeClass("opacity-50"),e.replaceWith('<i class="action ml-2 fas fa-fw fa-eye hint" '+`   data-original-title="${MyAMS.portal.i18n.SWITCH_SLOT_VISIBILITY}" `+'   data-ams-click-handler="MyAMS.portal.template.switchSlotVisibility"></i>')):($(".portlets",a).addClass("opacity-50"),e.replaceWith('<i class="action ml-2 fas fa-fw fa-eye-slash text-danger hint" '+`   data-original-title="${MyAMS.portal.i18n.SWITCH_SLOT_VISIBILITY}" `+'   data-ams-click-handler="MyAMS.portal.template.switchSlotVisibility"></i>'))})})},deleteSlot:t=>{const e=$(t.currentTarget).objectOrParentWithClass("slot"),a=$(".portlet",e);MyAMS.require("alert").then(()=>{a.exists()?MyAMS.alert.messageBox({status:"error",title:MyAMS.i18n.ERROR_OCCURED,content:MyAMS.portal.i18n.CANT_DELETE_SLOT_WITH_PORTLETS}):MyAMS.alert.bigBox({status:"danger",title:MyAMS.i18n.WARNING,message:MyAMS.i18n.DELETE_WARNING,icon:"fas fa-bell"}).then(t=>{"success"===t&&MyAMS.require("ajax").then(()=>{MyAMS.ajax.post(`${getLocation()}/delete-template-slot.json`,{slot_name:e.data("ams-slot-name")}).then(t=>{"success"===t.status&&(e.remove(),$(".slot","#portal_config").each((t,e)=>{$(e).removeData()}))})})})})},addPortlet:()=>(function(t){$(t).parents(".dropdown").dropdown("hide"),MyAMS.require("modal").then(()=>{MyAMS.modal.open(`${getLocation()}/add-template-portlet.html`)})}),addPortletCallback:(t,e)=>{const a=$(".portlets",`.slot[data-ams-slot-name="${e.slot_name}"]`),o=$("<div></div>").addClass("portlet").attr("data-ams-portlet-id",e.portlet_id).append(e.preview||"");MyAMS.core.initContent($(".preview",o)).then(()=>{const t=$(".btn-portlet",a);t.exists()?(t.replaceWith(o),$(".portlet",a).each((t,e)=>{$(e).removeData()}),MyAMS.portal.template.sortPortlets(null,{item:o})):o.appendTo(a),a.sortable("refresh"),MyAMS.require("modal").then(()=>{MyAMS.modal.open(`${getLocation()}/portlet-properties.html?form.widgets.portlet_id=${e.portlet_id}`).then(t=>{t.on("hide.bs.modal",a=>{$("form",t).data("submitted")||MyAMS.portal.template.doDeletePortlet(e.portlet_id)})})})})},dropPortletButton:(t,e)=>{const a=e.draggable,o=a.parents(".slot:first");a.hasClass("already-dropped")||(a.addClass("already-dropped"),MyAMS.require("ajax").then(()=>{a.tooltip("hide"),MyAMS.ajax.post(`${getLocation()}/drop-template-portlet.json`,{portlet_name:a.data("ams-portlet-name"),slot_name:o.data("ams-slot-name")}).then(t=>{MyAMS.ajax.handleJSON(t)})}))},submitPortletEditForm:t=>{const e=$(t).parents("form").first(),a=$('button[type="submit"]',e).first();MyAMS.require("form").then(()=>{const t={autosubmit:!0};t[a.attr("name")]=a.val(),MyAMS.form.submit(e,{data:t})})},editPortlet:t=>{MyAMS.require("modal").then(()=>{const e=$(t.currentTarget).objectOrParentWithClass("portlet");MyAMS.modal.open(`${getLocation()}/portlet-properties.html?form.widgets.portlet_id=${e.data("ams-portlet-id")}`)})},editPortletCallback:(t,e)=>{if(e.preview){const t=$("#portal_config"),a=$(`.portlet[data-ams-portlet-id="${e.portlet_id}"]`,t);a.html(e.preview),MyAMS.core.initContent($(".preview",a))}},overPortlets:(t,e)=>{$(e.placeholder).attr("class",$(e.item).attr("class")).removeClassPrefix("ui-").addClass("portlet-highlight").css("height",$(e.item).outerHeight())},sortPortlets:(t,e)=>{if(e.item.hasClass("already-dropped"))return;const a=e.item,o=a.parents(".slot"),s=$(".portlet",o),r={from:a.data("ams-portlet-id"),to:{slot:o.data("ams-slot-name"),portlet_ids:s.listattr("data-ams-portlet-id")}};MyAMS.ajax.post(`${getLocation()}/set-template-portlet-order.json`,{order:JSON.stringify(r)})},switchPortlet:t=>{const e=$(t.currentTarget),a=e.parents(".header").first().siblings(".preview");a.hasClass("hidden")?(a.removeClass("hidden"),MyAMS.core.switchIcon(e,"plus-square","minus-square")):(a.addClass("hidden"),MyAMS.core.switchIcon(e,"minus-square","plus-square"))},deletePortlet:t=>{MyAMS.require("alert").then(()=>{MyAMS.alert.bigBox({status:"danger",title:MyAMS.i18n.WARNING,message:MyAMS.i18n.DELETE_WARNING,icon:"fas fa-bell"}).then(e=>{const a=$(t.currentTarget).objectOrParentWithClass("portlet");"success"===e&&MyAMS.portal.template.doDeletePortlet(a.data("ams-portlet-id"))})})},doDeletePortlet:t=>{MyAMS.require("ajax").then(()=>{MyAMS.ajax.post(`${getLocation()}/delete-template-portlet.json`,{portlet_id:t}).then(e=>{if("success"===e.status){$(`.portlet[data-ams-portlet-id="${t}"]`).remove(),$(".portlet","#portal_config").each(function(){$(this).removeData()})}})})}},presentation:{handleChange:!0,resetTemplate:function(t){MyAMS.portal.presentation.handleChange=!1},setSharedTemplate:t=>{if(MyAMS.portal.presentation.handleChange){const e=$(t.target).parents("form");$('input[id="shared_template_mode"]',e).prop("checked",!0)}MyAMS.portal.presentation.handleChange=!0}},renderer:{init:(t,e,a)=>{const o=$("#portal_config");if(o.exists()){const e=t.val(),a=o.data("ams-page-name"),s=t.parents("form"),r=$('input[name="form.widgets.portlet_id"]',s).val();MyAMS.require("ajax").then(()=>{MyAMS.ajax.get("get-renderers.json",{page_name:a,portlet_id:r}).then(a=>{t.empty(),$(a.items).each((a,o)=>{const s=new Option(o.text,o.id,o.id===e,o.id===e);$(s).attr("data-ams-portal-img",o.img),t.append(s)})})})}},formatRenderer:t=>{const e=$(t.element).data("amsPortalImg");return e?$('<span class="renderer-image">'+`   <img class="thumbnail w-100px mr-3" src="${e}" alt="" />`+t.text+"</span>"):t.text}}};if(window.MyAMS){MyAMS.config.modules.push("portal"),MyAMS.portal=portal,console.debug("MyAMS: portal module loaded...");const t=$("html"),e=t.attr("lang")||t.attr("xml:lang");e&&!e.startsWith("en")&&MyAMS.core.getScript(`/--static--/pyams_portal/js/i18n/layout-${e.substr(0,2)}.js`)}